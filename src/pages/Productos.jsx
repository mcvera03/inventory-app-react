import React, {useState, useEffect} from 'react'
import { supabase } from '../lib/supabase'
import ProductForm from '../components/products/ProductForm'
export default function Productos(){ const [products,setProducts]=useState([]); const [q,setQ]=useState(''); const [loading,setLoading]=useState(true); const [showForm,setShowForm]=useState(false); const [edit,setEdit]=useState(null);
  const fetch=async()=>{ setLoading(true); let query=supabase.from('products').select('*').order('id',{ascending:false}); if(q) query=query.ilike('name',`%${q}%`); const {data,error}=await query; if(error) return alert(error.message); setProducts(data); setLoading(false); }
  useEffect(()=>{ fetch() },[q]);
  const remove=async(id)=>{ if(!confirm('Eliminar?'))return; const {error}=await supabase.from('products').delete().eq('id',id); if(error) alert(error.message); else fetch(); }
  return (<div><h1>Productos</h1><div className='toolbar'><input className='big-search' placeholder='Buscar' value={q} onChange={e=>setQ(e.target.value)}/><button className='button' onClick={()=>{setEdit(null); setShowForm(true)}}>Agregar producto</button></div>{loading? <p>Cargando...</p>: (<table className='table'><thead><tr><th>ID</th><th>CÃ³digo</th><th>Nombre</th><th>Stock</th><th>Precio</th><th></th></tr></thead><tbody>{products.map(p=>(<tr key={p.id}><td>{p.id}</td><td>{p.code}</td><td>{p.name}</td><td style={{color:p.stock_actual<=p.stock_minimo?'red':'inherit'}}>{p.stock_actual}</td><td>{p.precio_unitario}</td><td><button className='button' onClick={()=>{setEdit(p); setShowForm(true)}}>Editar</button> <button className='button-secondary' onClick={()=>remove(p.id)}>Eliminar</button></td></tr>))}</tbody></table>) }{showForm && <ProductForm product={edit} onClose={()=>setShowForm(false)} onSaved={fetch} />}</div>) }
